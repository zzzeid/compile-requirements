name: Generate Requirements

on:
    workflow_call:
        inputs:
            os:
                required: true
                type: string
            python:
                required: true
                type: string

jobs:
  compile-requirements:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: ${{ fromJSON(inputs.os) }}
        python-version: ${{ fromJSON(inputs.python) }}
    steps:
      - uses: actions/checkout@v2
        with:
            persist-credentials: false
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade pip-tools
      - name: Generate
        # Generate filename based on Python version and OS.
        run: |
            cd requirements
            python -m piptools compile --generate-hashes --output-file requirements-${{ matrix.python-version }}-${{ runner.os }}.txt
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/upload-artifact@v2
        with:
            name: requirements-${{ matrix.python-version }}-${{ runner.os }}.txt
            path: requirements/requirements-*.txt
  commit-and-push:
    needs: compile-requirements
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
            persist-credentials: false
      - uses: actions/download-artifact@v3
        with:
            path: temp-requirements
      - name: Configure git
        run: |
            git config user.name pip-tools compile
            git config user.email nomail@example.org
      - name: Commit and push
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
            mv temp-requirements/requirements-*/* requirements/.
            rm -R temp-requirements
            git add -A
            git commit -m "Automatically generated requirements"
            git pull -f https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git --rebase
            git push -f https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
